angular.module("starter").factory("Pages",function($pwaRequest,$rootScope,$q,$log,SB){var factory={data:null,features:[],touched:[],last_refresh:-1,refresh_interval:$rootScope.isOverview?0:300,is_refreshing:!1},_ready=!1,_ready_resolver=$q.defer();return Object.defineProperty(factory,"ready",{get:function(){return _ready?($log.info("Pages ready, resolving promise"),$q.resolve()):_ready_resolver.promise},set:function(value){!0===(_ready=!!value)&&($log.info("Pages ready, resolving promise"),_ready_resolver.resolve())}}),factory.populate=function(data){return factory.data=angular.copy(data),factory.features=angular.copy(data.pages),factory.data.pages=_.filter(data.pages,{homepage:!0}),data.hasOwnProperty("touched")&&(factory.touched=data.touched,factory.last_refresh=Math.trunc(Date.now()/1e3)),$rootScope.$broadcast(SB.EVENTS.CACHE.pagesReload),factory.ready=!0,$q.resolve(data)},factory.getActivePages=function(){return _.filter(factory.features,{is_active:!0})},factory.refresh=function(){$pwaRequest.get("front/mobile/pagesv2",{refresh:!0}).then(function(data){factory.features=angular.copy(data.pages),factory.data.pages=_.filter(data.pages,{homepage:!0})})},factory.updateTouched=function(){var deferred=$q.defer(),past_refresh=factory.last_refresh+factory.refresh_interval,now=Math.trunc(Date.now()/1e3);return!factory.is_refreshing&&past_refresh<now?(factory.is_refreshing=!0,$pwaRequest.get("front/mobile/touched",{refresh:!0}).then(function(data){var will_refresh=!1;angular.forEach(data.touched,function(feature,value_id){factory.touched.hasOwnProperty(value_id)&&(factory.touched[value_id].touched_at<feature.touched_at||feature.expires_at<now)&&(will_refresh=!0)}),factory.touched=data.touched,factory.last_refresh=now,deferred.resolve(factory.touched),will_refresh&&factory.refresh(),factory.is_refreshing=!1})):deferred.resolve(factory.touched),deferred.promise},factory.getForValueId=function(value_id){return factory.updateTouched(),factory.touched.hasOwnProperty(value_id)?factory.touched[value_id]:{touched_at:-1,expires_at:-1}},factory.getLayoutIdForValueId=function(value_id){return _.get(_.filter(factory.features,function(feature){return feature.value_id==value_id})[0],"layout_id",1)},factory.getTouchedAt=function(value_id){return factory.getForValueId(value_id).touched_at},factory.getExpiresAt=function(value_id){return factory.getForValueId(value_id).expires_at},factory.getLayoutIdForValueId=function(value_id){return _.get(_.filter(factory.features,{value_id:1*value_id})[0],"layout_id",1)},factory.getPayloadForValueId=function(value_id){return _.get(_.filter(factory.features,{value_id:1*value_id})[0],"embed_payload",!1)},factory});