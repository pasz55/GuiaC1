angular.module("starter").factory("Weather",function($q,$pwaRequest,$cordovaGeolocation,GoogleMaps){var factory={value_id:null,extendedOptions:{}};return factory.setValueId=function(value_id){factory.value_id=value_id},factory.setExtendedOptions=function(options){factory.extendedOptions=options},factory.find=function(){if(!this.value_id)return $pwaRequest.reject("[Factory::Weather.find] missing value_id");var payload=$pwaRequest.getPayloadForValueId(factory.value_id);return!1!==payload?$pwaRequest.resolve(payload):$pwaRequest.get("weather/mobile_view/find",angular.extend({urlParams:{value_id:this.value_id}},factory.extendedOptions))},factory.getWeather=function(woeid,unit){var deferred=$q.defer();return woeid?factory.getWeatherFromWoeid(woeid,unit).then(function(data){data.query.results.channel.astronomy?deferred.resolve(data):deferred.reject("Unable to get weather for this location.")},function(){deferred.reject("Unable to get weather.")}):$cordovaGeolocation.getCurrentPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:0}).then(function(position){GoogleMaps.reverseGeocode(position.coords).then(function(data){var postal_code=null,country=null;if(data[0].address_components[6]&&"postal_code"==data[0].address_components[6].types[0]&&(postal_code=data[0].address_components[6].long_name),data[0].address_components[5]&&(country=data[0].address_components[5].short_name),country){var param="";param=postal_code?postal_code+","+country:country,factory.getWoeid(param).then(function(data){var woeid=null;data.query.count>0&&(woeid=data.query.results.place.length>1?data.query.results.place[0].woeid:data.query.results.place.woeid),woeid?factory.getWeatherFromWoeid(woeid,unit).then(function(data){data.query.results.channel.astronomy?deferred.resolve(data):deferred.reject("Unable to get weather for this location.")},function(){deferred.reject("Unable to get weather.")}):deferred.reject("Unable to get your woeid.")},function(){deferred.reject("Unable to get your woeid.")})}else deferred.reject()},function(message){deferred.reject(message)})},function(err){deferred.reject(err)}),deferred.promise},factory.getWoeid=function(param){var yql=encodeURI("select woeid from geo.places where text='"+param+"'");return $pwaRequest.post("/weather/mobile_view/proxy",{data:{request:btoa("https://query.yahooapis.com/v1/public/yql?q="+yql+"&format=json")},cache:!1})},factory.getWeatherFromWoeid=function(woeid,unit){var yql=encodeURI("select * from weather.forecast where woeid='"+woeid+"' and u='"+unit+"'");return $pwaRequest.post("/weather/mobile_view/proxy",{data:{request:btoa("https://query.yahooapis.com/v1/public/yql?q="+yql+"&format=json&lang=fr-FR")},cache:!1})},factory});