angular.module("starter").controller("DiscountListController",function($cordovaBarcodeScanner,$filter,Modal,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Application,Customer,Dialog,Discount,Url,SB,SocialSharing,Tc){angular.extend($scope,{is_loading:!1,value_id:$stateParams.value_id,is_logged_in:Customer.isLoggedIn(),social_sharing_active:!1,load_more:!1,card_design:!1,use_pull_refresh:!0,collection:[],pull_to_refresh:!1}),Discount.setValueId($stateParams.value_id),$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0,$scope.loadContent(!0)}),$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1,$scope.loadContent(!0)}),$rootScope.$on(SB.EVENTS.CACHE.clearDiscount,function(event,args){$scope.remove(args.discount_id)}),$scope.loadContent=function(pullToRefresh){$scope.is_loading=!0,Discount.findAll(pullToRefresh).then(function(data){return $scope.collection=angular.copy(data.promotions),$scope.collection_chunks=$filter("chunk")($scope.collection,2),$scope.tc_id=data.tc_id,$scope.social_sharing_active=data.social_sharing_is_active&&$rootScope.isNativeApp,$scope.page_title=data.page_title,data},function(error){}).then(function(data){$scope.pull_to_refresh&&($scope.$broadcast("scroll.refreshComplete"),$scope.pull_to_refresh=!1),$scope.is_loading=!1,data.tc_id&&Tc.find(data.tc_id,pullToRefresh),angular.forEach(data.promotions,function(promotion){Discount.find(promotion.id,pullToRefresh)})})},$scope.getState=function(){return $scope.is_loading||!$scope.collection||$scope.collection.length?"RESULTS":"NO_RESULTS"},$scope.pullToRefresh=function(){$scope.pull_to_refresh=!0,$scope.loadContent(!0)},$scope.share=function(){var content=$scope.collection[$scope.carousel_index].title?$scope.collection[$scope.carousel_index].title:null;SocialSharing.share(content,"I just found this discount $1 in $2 app.")},$scope.login=function(){Customer.loginModal($scope)},$scope.use=function(discount_id){$rootScope.isNotAvailableInOverview()||Discount.use(discount_id).then(function(data){Dialog.alert("Success",data.message,"OK",-1),data.remove&&$rootScope.$broadcast(SB.EVENTS.CACHE.clearDiscount,{discount_id:discount_id})},function(data){data&&(angular.isDefined(data.message)&&Dialog.alert("Error",data.message,"OK",-1),data.remove&&$scope.remove(discount_id))})},$scope.remove=function(discount_id){$timeout(function(){_.remove($scope.collection,function(discount){return 1*discount.id==1*discount_id}),Discount.findAll()},1)},$scope.openScanCamera=function(){Application.is_webview?Dialog.alert("Info","This will open the code scan camera on your device.","OK"):($scope.scan_protocols=["sendback:"],$scope.is_logged_in?$scope.showScanCamera():$scope.login())},$scope.showScanCamera=function(){$cordovaBarcodeScanner.scan().then(function(barcodeData){barcodeData.cancelled||""==barcodeData.text||$timeout(function(){for(var i=0;i<$scope.scan_protocols.length;i++)if(0==barcodeData.text.toLowerCase().indexOf($scope.scan_protocols[i])){$scope.is_loading=!0;var qrcode=barcodeData.text.replace($scope.scan_protocols[i],"");Discount.unlockByQRCode(qrcode).then(function(data){for(var i=0;i<$scope.collection.length;i++)if($scope.collection[i].id==data.promotion.id){$scope.collection[i]=data.promotion,console.log($scope.collection[i]);break}$state.go("discount-view",{value_id:$scope.value_id,promotion_id:data.promotion.id}),$scope.is_loading=!1},function(data){var message_text="An error occurred while reading the code.";angular.isObject(data)&&(message_text=data.message),Dialog.alert("Error",message_text,"OK",-1)}).then(function(){$scope.is_loading=!1});break}})},function(error){Dialog.alert("Error","An error occurred while reading the code.","OK",-1)})},$rootScope.isOverview&&($scope.dummy={},$scope.dummy.is_dummy=!0,$window.prepareDummy=function(){},$window.setAttributeToDummy=function(attribute,value){},$scope.$on("$destroy",function(){$scope.prepareDummy=null,$scope.setAttributeToDummy=null})),$scope.showItem=function(item){item.is_locked?$scope.openScanCamera():$state.go("discount-view",{value_id:$scope.value_id,promotion_id:item.id})},$scope.showTc=function(){$state.go("tc-view",{tc_id:$scope.tc_id})},$scope.loadContent(!1)}).controller("DiscountViewController",function($cordovaSocialSharing,$ionicHistory,Modal,$ionicPopup,$rootScope,$scope,$state,$stateParams,$timeout,$translate,$window,Application,Customer,Dialog,Discount,Url,SB,SocialSharing,Loader){angular.extend($scope,{is_loading:!1,value_id:$stateParams.value_id,is_logged_in:Customer.isLoggedIn(),card_design:!1,use_pull_to_refresh:!1,social_sharing_active:!1}),$scope.$on(SB.EVENTS.AUTH.loginSuccess,function(){$scope.is_logged_in=!0,$scope.loadContent()}),$scope.$on(SB.EVENTS.AUTH.logoutSuccess,function(){$scope.is_logged_in=!1,$scope.loadContent()}),Discount.setValueId($stateParams.value_id),$scope.loadContent=function(){Discount.find($stateParams.promotion_id).then(function(data){$scope.promotion=data.promotion,$scope.modal_title=data.confirm_message,$scope.tc_id=data.tc_id,$scope.social_sharing_active=!(1!=data.social_sharing_is_active||Application.is_webview),$scope.page_title=data.page_title}).then(function(){$scope.is_loading=!1})},$scope.share=function(){SocialSharing.share()},$scope.login=function(){Customer.loginModal($scope)},$scope.confirmBeforeUse=function(){if(!$rootScope.isNotAvailableInOverview()){var buttons=["Yes","No"];Dialog.confirm("Confirmation",$scope.modal_title,buttons,"text-center").then(function(result){result&&$scope.use()})}},$scope.use=function(){Loader.show(),Discount.use($stateParams.promotion_id).then(function(data){Dialog.alert("Thank you",data.message,"OK",-1).then(function(){data.remove&&Discount.findAll(!0).then(function(){$rootScope.$broadcast(SB.EVENTS.CACHE.clearDiscount,{discount_id:$stateParams.promotion_id}),$ionicHistory.goBack()})})},function(data){Dialog.alert("Error",data.message,"OK",-1).then(function(){data.remove&&Discount.findAll(!0).then(function(){$rootScope.$broadcast(SB.EVENTS.CACHE.clearDiscount,{discount_id:$stateParams.promotion_id}),$ionicHistory.goBack()})})}).then(function(){Loader.hide()})},$scope.showTc=function(){$state.go("tc-view",{tc_id:$scope.tc_id})},$scope.loadContent()});